# å¾®ä¿¡å…¬ä¼—å·å‘å¸ƒå·¥å…· - é¡¹ç›®ç»“æ„

```
wechat-publisher/
â”œâ”€â”€ wechat-auth.js           # å¾®ä¿¡è®¤è¯å’ŒTokenç®¡ç†
â”œâ”€â”€ article-converter.js     # æ–‡ç« æ ¼å¼è½¬æ¢å™¨
â”œâ”€â”€ wechat-publisher.js      # æ ¸å¿ƒå‘å¸ƒå™¨
â”œâ”€â”€ sync-to-wechat.js        # ä¸»è„šæœ¬(Sanityé›†æˆ)
â”œâ”€â”€ README.md                # å®Œæ•´ä½¿ç”¨æ–‡æ¡£
â”œâ”€â”€ å¿«é€Ÿå¼€å§‹.md              # å¿«é€Ÿä¸Šæ‰‹æŒ‡å—
â”œâ”€â”€ .env.example             # ç¯å¢ƒå˜é‡ç¤ºä¾‹
â”œâ”€â”€ .wechat-token.json       # Tokenç¼“å­˜(è‡ªåŠ¨ç”Ÿæˆ)
â””â”€â”€ publish-log.json         # å‘å¸ƒæ—¥å¿—(è‡ªåŠ¨ç”Ÿæˆ)
```

## æ ¸å¿ƒæ¨¡å—è¯´æ˜

### 1. wechat-auth.js - è®¤è¯æ¨¡å—

**åŠŸèƒ½**:
- è·å–å’Œåˆ·æ–° access_token
- æœ¬åœ°ç¼“å­˜ token,é¿å…é¢‘ç¹è¯·æ±‚
- è‡ªåŠ¨å¤„ç† token è¿‡æœŸ

**ä¸»è¦æ–¹æ³•**:
- `getAccessToken()` - è·å–æœ‰æ•ˆçš„ access_token
- `refreshAccessToken()` - ä»å¾®ä¿¡æœåŠ¡å™¨è·å–æ–°token
- `saveTokenToFile()` / `loadTokenFromFile()` - tokenæŒä¹…åŒ–

### 2. article-converter.js - æ ¼å¼è½¬æ¢æ¨¡å—

**åŠŸèƒ½**:
- å°† Sanity åšå®¢æ–‡ç« è½¬æ¢ä¸ºå¾®ä¿¡å…¬ä¼—å·æ ¼å¼
- ä¼˜åŒ–æ ‡é¢˜å’Œæ‘˜è¦
- æ·»åŠ å¯¼æµå†…å®¹å’Œç½‘ç«™é“¾æ¥
- Markdown è½¬ HTML

**ä¸»è¦æ–¹æ³•**:
- `convertToWeChatArticle(article)` - è½¬æ¢æ–‡ç« ä¸ºå…¬ä¼—å·æ ¼å¼
- `optimizeTitle(title)` - ä¼˜åŒ–æ ‡é¢˜(æœ€é•¿64å­—ç¬¦)
- `buildResourceSection()` - æ„å»ºèµ„æºè·å–å¼•å¯¼
- `buildFooter()` - æ„å»ºåº•éƒ¨å¯¼æµå†…å®¹

**å¯¼æµç­–ç•¥**:
```javascript
// 1. æ‘˜è¦ä¸­æ·»åŠ æç¤º
"ğŸ”— ç‚¹å‡»é˜…è¯»åŸæ–‡è·å–ç½‘ç›˜èµ„æºé“¾æ¥"

// 2. æ–‡ç« ä¸­é—´æ·»åŠ é†’ç›®å¼•å¯¼æ¡†
"ğŸ“¦ å¦‚ä½•è·å–èµ„æº?"
"ğŸ‘‰ ç‚¹å‡»ã€é˜…è¯»åŸæ–‡ã€‘å³å¯æŸ¥çœ‹æ‰€æœ‰èµ„æºé“¾æ¥ ğŸ‘ˆ"

// 3. åº•éƒ¨æ·»åŠ ç½‘ç«™ä¿¡æ¯
"â­ æ›´å¤šä¼˜è´¨èµ„æº,è¯·è®¿é—®æˆ‘ä»¬çš„ç½‘ç«™"
"www.sswl.top"
```

### 3. wechat-publisher.js - å‘å¸ƒå™¨æ¨¡å—

**åŠŸèƒ½**:
- ä¸Šä¼ å›¾ç‰‡ç´ æ
- åˆ›å»ºå›¾æ–‡è‰ç¨¿
- å‘å¸ƒ/ç¾¤å‘æ–‡ç« 
- æ‰¹é‡å‘å¸ƒç®¡ç†
- æ—¥å¿—è®°å½•

**ä¸»è¦æ–¹æ³•**:
- `uploadImage(imagePath)` - ä¸Šä¼ ä¸´æ—¶ç´ æ
- `uploadPermanentImage(imagePath)` - ä¸Šä¼ æ°¸ä¹…ç´ æ(å°é¢)
- `createDraft(article)` - åˆ›å»ºè‰ç¨¿
- `publishDraft(mediaId)` - å‘å¸ƒè‰ç¨¿
- `publish(article, autoPublish)` - ä¸€é”®å‘å¸ƒ
- `batchPublish(articles, options)` - æ‰¹é‡å‘å¸ƒ

**å‘å¸ƒæµç¨‹**:
```
article â†’ éªŒè¯æ ¼å¼
         â†“
       ä¸Šä¼ å°é¢
         â†“
       åˆ›å»ºè‰ç¨¿
         â†“
     [å¯é€‰]å‘å¸ƒ
         â†“
       è®°å½•æ—¥å¿—
```

### 4. sync-to-wechat.js - ä¸»è„šæœ¬

**åŠŸèƒ½**:
- é›†æˆ Sanity CMS
- è·å–åšå®¢æ–‡ç« 
- è°ƒç”¨å‘å¸ƒå™¨
- æ›´æ–°å‘å¸ƒçŠ¶æ€
- å‘½ä»¤è¡Œå‚æ•°è§£æ

**ä¸»è¦å‡½æ•°**:
- `fetchArticlesFromSanity(limit)` - ä»Sanityè·å–æ–‡ç« 
- `markAsPublished(articleId, mediaId)` - æ ‡è®°å·²å‘å¸ƒ
- `main()` - ä¸»æµç¨‹æ§åˆ¶

**å‘½ä»¤è¡Œå‚æ•°**:
```bash
--auto-publish    # è‡ªåŠ¨å‘å¸ƒ(ä¸åŠ åˆ™ä»…åˆ›å»ºè‰ç¨¿)
--limit=N         # å‘å¸ƒæ•°é‡é™åˆ¶
--help            # å¸®åŠ©ä¿¡æ¯
```

## æ•°æ®æµè½¬

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Sanity CMS â”‚
â”‚  (åšå®¢æ–‡ç« )  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚ fetch
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ sync-to-wechat  â”‚
â”‚   (ä¸»è„šæœ¬)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ convert
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ article-converterâ”‚
â”‚   (æ ¼å¼è½¬æ¢)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ publish
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ wechat-publisher â”‚
â”‚   (å‘å¸ƒç®¡ç†)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ auth
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  wechat-auth     â”‚
â”‚   (è·å–token)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â†“ APIè°ƒç”¨
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å¾®ä¿¡å…¬ä¼—å¹³å°    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## APIæ¥å£è¯´æ˜

### å¾®ä¿¡å…¬ä¼—å¹³å° API

å·¥å…·ä½¿ç”¨ä»¥ä¸‹å¾®ä¿¡ API:

1. **è·å– access_token**
   - URL: `https://api.weixin.qq.com/cgi-bin/token`
   - ç”¨é€”: è·å–æ¥å£è°ƒç”¨å‡­è¯

2. **ä¸Šä¼ ä¸´æ—¶ç´ æ**
   - URL: `https://api.weixin.qq.com/cgi-bin/media/upload`
   - ç”¨é€”: ä¸Šä¼ å›¾ç‰‡ç­‰ç´ æ(3å¤©æœ‰æ•ˆ)

3. **ä¸Šä¼ æ°¸ä¹…ç´ æ**
   - URL: `https://api.weixin.qq.com/cgi-bin/material/add_material`
   - ç”¨é€”: ä¸Šä¼ å°é¢å›¾(æ°¸ä¹…æœ‰æ•ˆ)

4. **æ–°å¢è‰ç¨¿**
   - URL: `https://api.weixin.qq.com/cgi-bin/draft/add`
   - ç”¨é€”: åˆ›å»ºå›¾æ–‡æ¶ˆæ¯è‰ç¨¿

5. **ç¾¤å‘æ¶ˆæ¯**
   - URL: `https://api.weixin.qq.com/cgi-bin/message/mass/sendall`
   - ç”¨é€”: å‘å¸ƒå›¾æ–‡æ¶ˆæ¯ç»™æ‰€æœ‰ç”¨æˆ·

## é…ç½®é€‰é¡¹

### ç¯å¢ƒå˜é‡

| å˜é‡å | è¯´æ˜ | å¿…å¡« |
|--------|------|------|
| `WECHAT_APP_ID` | å…¬ä¼—å·AppID | âœ… |
| `WECHAT_APP_SECRET` | å…¬ä¼—å·AppSecret | âœ… |
| `NEXT_PUBLIC_BASE_URL` | ç½‘ç«™URL(å¯¼æµç”¨) | âœ… |
| `NEXT_PUBLIC_SANITY_PROJECT_ID` | Sanityé¡¹ç›®ID | âœ… |
| `SANITY_API_TOKEN` | Sanity APIä»¤ç‰Œ | âœ… |

### å‘å¸ƒé€‰é¡¹

```javascript
{
  autoPublish: false,    // æ˜¯å¦è‡ªåŠ¨å‘å¸ƒ
  interval: 60000,       // å‘å¸ƒé—´éš”(æ¯«ç§’)
  limit: 5               // æ¯æ¬¡æœ€å¤šå‘å¸ƒæ•°é‡
}
```

## æ—¥å¿—æ ¼å¼

### publish-log.json

```json
[
  {
    "title": "æ–‡ç« æ ‡é¢˜",
    "slug": "article-slug",
    "status": "draft",      // draft/published/failed
    "id": "media_id_xxx",   // media_id æˆ– msg_id
    "error": null,
    "timestamp": "2024-01-01T10:00:00.000Z"
  }
]
```

## æ‰©å±•å¼€å‘

### æ·»åŠ è‡ªå®šä¹‰è½¬æ¢è§„åˆ™

ç¼–è¾‘ `article-converter.js`:

```javascript
convertContent(content, netdiskLinks, articleUrl) {
  // åœ¨è¿™é‡Œæ·»åŠ ä½ çš„è‡ªå®šä¹‰è½¬æ¢é€»è¾‘
  let html = this.markdownToHtml(content);

  // ä¾‹å¦‚:æ·»åŠ è‡ªå®šä¹‰æ ·å¼
  html = html.replace(/<h2>/g, '<h2 style="color: #your-color;">');

  return html;
}
```

### æ·»åŠ å‘å¸ƒå‰é’©å­

ç¼–è¾‘ `wechat-publisher.js`:

```javascript
async publish(article, autoPublish = false) {
  // å‘å¸ƒå‰é’©å­
  await this.beforePublish(article);

  // åŸæœ‰å‘å¸ƒé€»è¾‘...

  // å‘å¸ƒåé’©å­
  await this.afterPublish(article, result);
}
```

### é›†æˆå…¶ä»–CMS

å‚è€ƒ `sync-to-wechat.js`,æ›¿æ¢ Sanity è·å–é€»è¾‘:

```javascript
async function fetchArticlesFromYourCMS(limit) {
  // ä»ä½ çš„CMSè·å–æ–‡ç« 
  const articles = await yourCMS.getArticles({ limit });
  return articles;
}
```

## å®‰å…¨æ³¨æ„äº‹é¡¹

1. **ä¸è¦æäº¤æ•æ„Ÿä¿¡æ¯**
   - `.env.local` å·²åœ¨ `.gitignore` ä¸­
   - `.wechat-token.json` å·²è‡ªåŠ¨å¿½ç•¥

2. **AppSecret ä¿æŠ¤**
   - å®šæœŸæ›´æ¢ AppSecret
   - ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç 
   - ä½¿ç”¨ç¯å¢ƒå˜é‡ç®¡ç†

3. **Token ç¼“å­˜**
   - Token æ–‡ä»¶ä»…æœ¬åœ°ä½¿ç”¨
   - ç”Ÿäº§ç¯å¢ƒè€ƒè™‘ä½¿ç”¨ Redis ç­‰ç¼“å­˜

4. **API é¢‘ç‡é™åˆ¶**
   - æ§åˆ¶å‘å¸ƒé¢‘ç‡
   - é¿å…çŸ­æ—¶é—´å¤§é‡è°ƒç”¨
   - å®ç°é‡è¯•æœºåˆ¶

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å›¾ç‰‡ä¼˜åŒ–**
   - å‹ç¼©å›¾ç‰‡å¤§å°
   - ä½¿ç”¨CDNåŠ é€Ÿ
   - å¼‚æ­¥ä¸Šä¼ 

2. **æ‰¹é‡å‘å¸ƒ**
   - è®¾ç½®åˆç†é—´éš”
   - åˆ†æ‰¹å¤„ç†å¤§é‡æ–‡ç« 
   - å®ç°é˜Ÿåˆ—ç®¡ç†

3. **é”™è¯¯å¤„ç†**
   - æ·»åŠ é‡è¯•é€»è¾‘
   - è®°å½•è¯¦ç»†æ—¥å¿—
   - å¼‚å¸¸æƒ…å†µé€šçŸ¥

---

ğŸ“š æŸ¥çœ‹å®Œæ•´ä½¿ç”¨æ•™ç¨‹: [README.md](./README.md)
