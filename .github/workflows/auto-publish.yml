name: AI Auto Publisher

on:
  # 当resources.json文件更新时触发
  push:
    paths:
      - 'resources.json'
    branches:
      - master

  # 定时触发 (每天运行3次)
  schedule:
    - cron: '0 9,15,21 * * *'  # 每天9点、15点、21点

  # 手动触发
  workflow_dispatch:
    inputs:
      publish_count:
        description: 'Number of posts to publish'
        required: false
        default: '1'

jobs:
  auto-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2  # 获取足够的历史记录用于比较

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # 升级到Node.js 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for new resources
        id: check-resources
        run: |
          # 检查resources.json是否有变化或手动触发
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "resources_changed=true" >> $GITHUB_OUTPUT
            echo "触发方式: ${{ github.event_name }}"
          elif git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "resources.json"; then
            echo "resources_changed=true" >> $GITHUB_OUTPUT
            echo "检测到resources.json变化"
          else
            echo "resources_changed=false" >> $GITHUB_OUTPUT
            echo "未检测到resources.json变化"
          fi

      - name: Run AI Auto Publisher
        if: steps.check-resources.outputs.resources_changed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          NEXT_PUBLIC_SANITY_PROJECT_ID: w7iihdoh
          NEXT_PUBLIC_SANITY_DATASET: production
          AUTO_PUBLISH: 'true'
          PUBLISH_DELAY: '30'
          PUBLISH_COUNT: ${{ github.event.inputs.publish_count || '1' }}
        run: |
          echo "🚀 Starting AI Auto Publisher..."
          echo "📊 Environment check:"
          echo "- SANITY_PROJECT_ID: $NEXT_PUBLIC_SANITY_PROJECT_ID"
          echo "- AUTO_PUBLISH: $AUTO_PUBLISH"
          echo "- PUBLISH_COUNT: $PUBLISH_COUNT"

          echo "📝 Running AI content generation..."
          node scripts/simple-publisher.mjs

          echo "✅ AI Auto Publisher completed!"

      - name: Backup processed resources
        if: success() && steps.check-resources.outputs.resources_changed == 'true'
        run: |
          # 简单备份，不修改原文件
          timestamp=$(date +%Y%m%d_%H%M%S)
          mkdir -p processed
          cp resources.json "processed/resources_backup_${timestamp}.json"
          echo "📦 Backup created: processed/resources_backup_${timestamp}.json"

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "✅ AI Auto Publisher completed successfully"
            echo "🔗 Check your blog: https://blog-delta-five-13.vercel.app"
          else
            echo "❌ AI Auto Publisher failed"
            echo "📋 Please check the logs for details"
          fi