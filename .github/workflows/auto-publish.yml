name: AI Auto Publisher

on:
  # ÂΩìresources.jsonÊñá‰ª∂Êõ¥Êñ∞Êó∂Ëß¶Âèë
  push:
    paths:
      - 'resources.json'
    branches:
      - master

  # ÂÆöÊó∂Ëß¶Âèë (ÊØèÂ§©ËøêË°å3Ê¨°)
  schedule:
    - cron: '0 9,15,21 * * *'  # ÊØèÂ§©9ÁÇπ„ÄÅ15ÁÇπ„ÄÅ21ÁÇπ

  # ÊâãÂä®Ëß¶Âèë
  workflow_dispatch:
    inputs:
      publish_count:
        description: 'Number of posts to publish'
        required: false
        default: '1'

jobs:
  auto-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for new resources
        id: check-resources
        run: |
          # Ê£ÄÊü•resources.jsonÊòØÂê¶ÊúâÂèòÂåñ
          if git diff --name-only HEAD~1 | grep -q "resources.json"; then
            echo "resources_changed=true" >> $GITHUB_OUTPUT
          else
            echo "resources_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Run AI Auto Publisher
        if: steps.check-resources.outputs.resources_changed == 'true' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          AUTO_PUBLISH: 'true'
          PUBLISH_DELAY: '30'
          PUBLISH_COUNT: ${{ github.event.inputs.publish_count || '1' }}
        run: |
          npx ts-node --esm scripts/auto-publisher.ts

      - name: Update processed resources
        if: success()
        run: |
          # Â§á‰ªΩÂ∑≤Â§ÑÁêÜÁöÑËµÑÊ∫ê
          timestamp=$(date +%Y%m%d_%H%M%S)
          cp resources.json "processed/resources_${timestamp}.json"

          # Ê∏ÖÁ©∫resources.jsonÊàñÊ†áËÆ∞Â∑≤Â§ÑÁêÜ
          echo "[]" > resources.json

      - name: Commit processed status
        if: success()
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add resources.json processed/
          git commit -m "ü§ñ Auto-processed resources on $(date)" || exit 0
          git push

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "‚úÖ AI Auto Publisher completed successfully"
          else
            echo "‚ùå AI Auto Publisher failed"
          fi