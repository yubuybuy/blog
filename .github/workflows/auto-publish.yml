name: AI Auto Publisher

on:
  # å½“resources.jsonæ–‡ä»¶æ›´æ–°æ—¶è§¦å‘
  push:
    paths:
      - 'resources.json'
    branches:
      - master

  # å®šæ—¶è§¦å‘ (æ¯å¤©è¿è¡Œ3æ¬¡)
  schedule:
    - cron: '0 9,15,21 * * *'  # æ¯å¤©9ç‚¹ã€15ç‚¹ã€21ç‚¹

  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      publish_count:
        description: 'Number of posts to publish'
        required: false
        default: '1'

jobs:
  auto-publish:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      actions: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 2  # è·å–è¶³å¤Ÿçš„å†å²è®°å½•ç”¨äºæ¯”è¾ƒ

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'  # å‡çº§åˆ°Node.js 20
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Check for new resources
        id: check-resources
        run: |
          # æ£€æŸ¥resources.jsonæ˜¯å¦æœ‰å˜åŒ–æˆ–æ‰‹åŠ¨è§¦å‘
          if [ "${{ github.event_name }}" = "workflow_dispatch" ] || [ "${{ github.event_name }}" = "schedule" ]; then
            echo "resources_changed=true" >> $GITHUB_OUTPUT
            echo "è§¦å‘æ–¹å¼: ${{ github.event_name }}"
          elif git diff --name-only HEAD~1 HEAD 2>/dev/null | grep -q "resources.json"; then
            echo "resources_changed=true" >> $GITHUB_OUTPUT
            echo "æ£€æµ‹åˆ°resources.jsonå˜åŒ–"
          else
            echo "resources_changed=false" >> $GITHUB_OUTPUT
            echo "æœªæ£€æµ‹åˆ°resources.jsonå˜åŒ–"
          fi

      - name: Run AI Auto Publisher
        if: steps.check-resources.outputs.resources_changed == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          COHERE_API_KEY: ${{ secrets.COHERE_API_KEY }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          NEXT_PUBLIC_SANITY_PROJECT_ID: w7iihdoh
          NEXT_PUBLIC_SANITY_DATASET: production
          AUTO_PUBLISH: 'true'
          PUBLISH_DELAY: '30'
          PUBLISH_COUNT: ${{ github.event.inputs.publish_count || '1' }}
        run: |
          echo "ğŸš€ Starting AI Auto Publisher..."
          echo "ğŸ“Š Environment check:"
          echo "- SANITY_PROJECT_ID: $NEXT_PUBLIC_SANITY_PROJECT_ID"
          echo "- AUTO_PUBLISH: $AUTO_PUBLISH"
          echo "- PUBLISH_COUNT: $PUBLISH_COUNT"

          echo "ğŸ“ Running AI content generation..."
          node scripts/simple-publisher.mjs

          echo "âœ… AI Auto Publisher completed!"

      - name: Backup processed resources
        if: success() && steps.check-resources.outputs.resources_changed == 'true'
        run: |
          # ç®€å•å¤‡ä»½ï¼Œä¸ä¿®æ”¹åŸæ–‡ä»¶
          timestamp=$(date +%Y%m%d_%H%M%S)
          mkdir -p processed
          cp resources.json "processed/resources_backup_${timestamp}.json"
          echo "ğŸ“¦ Backup created: processed/resources_backup_${timestamp}.json"

      - name: Send notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… AI Auto Publisher completed successfully"
            echo "ğŸ”— Check your blog: https://blog-delta-five-13.vercel.app"
          else
            echo "âŒ AI Auto Publisher failed"
            echo "ğŸ“‹ Please check the logs for details"
          fi